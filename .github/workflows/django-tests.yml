name: FitZone CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    env:
      SECRET_KEY: test-secret-key-for-github-actions-ci-only
      DEBUG: False
      ALLOWED_HOSTS: localhost,127.0.0.1,testserver
      DJANGO_SETTINGS_MODULE: fitzone.settings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev libpq-dev

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Create media directories
        run: |
          mkdir -p media/{sliders,programs,trainers,gallery,testimonials,profiles}

      - name: Check for missing migrations
        run: |
          python manage.py makemigrations --check --dry-run
          echo "âœ… No missing migrations"

      - name: Check Django configuration
        run: |
          python manage.py check
          echo "âœ… Django check passed"

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # CRITICAL FIX: Delete old database before migrations
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Delete old database (fresh start for AbstractBaseUser)
        run: |
          rm -f db.sqlite3
          echo "âœ… Old database deleted - starting fresh"

      - name: Run migrations
        run: |
          python manage.py migrate --noinput
          echo "âœ… Migrations applied successfully"

      - name: Verify custom user model (AbstractBaseUser)
        run: |
          python manage.py shell -c "
          from django.contrib.auth import get_user_model
          from booking.models import GymUser
          
          User = get_user_model()
          print(f'âœ… User model: {User}')
          
          assert User.__name__ == 'GymUser', f'Expected GymUser, got {User.__name__}'
          assert User is GymUser, 'get_user_model() must return GymUser'
          assert User.USERNAME_FIELD == 'phone', f'USERNAME_FIELD is {User.USERNAME_FIELD}, expected phone'
          assert User.REQUIRED_FIELDS == [], f'REQUIRED_FIELDS should be empty, got {User.REQUIRED_FIELDS}'
          
          print('âœ… AbstractBaseUser configuration verified')
          "

      - name: Verify GymUserManager
        run: |
          python manage.py shell -c "
          from booking.models import GymUser
          
          member = GymUser.objects.create_user(phone='9990000001', email='test@ci.com')
          assert not member.has_usable_password(), 'Member must have unusable password (OTP-based)'
          assert member.is_staff is False, 'Member should not be staff'
          assert member.is_active is True, 'Member should be active'
          print('âœ… create_user() works correctly')
          
          admin = GymUser.objects.create_superuser(
              phone='9990000002',
              email='admin@ci.com',
              password='testpass123'
          )
          assert admin.has_usable_password(), 'Superuser must have usable password'
          assert admin.check_password('testpass123'), 'Superuser password must match'
          assert admin.is_staff is True, 'Superuser must be staff'
          assert admin.is_superuser is True, 'Superuser must have superuser flag'
          print('âœ… create_superuser() works correctly')
          
          GymUser.objects.filter(phone__in=['9990000001', '9990000002']).delete()
          print('âœ… GymUserManager fully verified')
          "

      - name: Collect static files
        continue-on-error: true
        run: python manage.py collectstatic --noinput --clear

      - name: Run all tests with coverage
        run: |
          pytest -v \
            --cov=booking \
            --cov=gym \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=90

      - name: Display coverage summary
        run: coverage report

      - name: Upload coverage to Codecov
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          file: ./coverage.xml
          flags: unittests
          name: fitzone-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Archive coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30

      - name: Archive test database on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-database-sqlite
          path: db.sqlite3
          retention-days: 7

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: flake8 critical errors
        run: |
          flake8 booking/ gym/ \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --exclude=migrations

      - name: flake8 all issues
        continue-on-error: true
        run: |
          flake8 booking/ gym/ \
            --count \
            --exit-zero \
            --max-complexity=10 \
            --max-line-length=127 \
            --statistics \
            --exclude=migrations

      - name: black formatting check
        continue-on-error: true
        run: |
          black --check booking/ gym/ || \
          echo "âš ï¸  Run 'black booking/ gym/' to fix formatting"

      - name: isort import check
        continue-on-error: true
        run: |
          isort --check-only booking/ gym/ || \
          echo "âš ï¸  Run 'isort booking/ gym/' to fix imports"

  security:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
          pip install -r requirements.txt

      - name: safety dependency scan
        continue-on-error: true
        run: |
          safety check --json || \
          echo "âš ï¸  Safety check completed with warnings"

      - name: bandit code scan
        continue-on-error: true
        run: |
          bandit -r booking/ gym/ \
            -ll \
            --exclude booking/migrations,gym/migrations,booking/tests,gym/tests \
            || echo "âš ï¸  Bandit scan completed with warnings"

  docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env for Docker
        run: |
          cat > .env << EOF
          SECRET_KEY=docker-ci-test-secret-key-only
          DEBUG=True
          ALLOWED_HOSTS=localhost,127.0.0.1
          EOF

      - name: Build Docker containers
        run: docker compose up -d --build

      - name: Wait for database to be ready
        run: |
          echo "â³ Waiting for PostgreSQL to be ready..."
          sleep 10
          docker compose exec -T db pg_isready -U fitzone_user || (docker compose logs db && exit 1)
          echo "âœ… PostgreSQL is ready"

      - name: Check container status
        run: docker compose ps

      - name: Run migrations in Docker
        run: |
          docker compose exec -T web python manage.py migrate --noinput
          echo "âœ… Migrations completed in Docker"

      - name: Verify custom user model in Docker
        run: |
          docker compose exec -T web python manage.py shell -c "
          from django.contrib.auth import get_user_model
          from booking.models import GymUser
          
          User = get_user_model()
          assert User.__name__ == 'GymUser', f'Expected GymUser in Docker, got {User.__name__}'
          assert User.USERNAME_FIELD == 'phone'
          print('âœ… GymUser model verified in Docker + PostgreSQL')
          "

      - name: Verify PostgreSQL connection
        run: |
          docker compose exec -T web python manage.py shell -c "
          from django.db import connection
          cursor = connection.cursor()
          cursor.execute('SELECT version();')
          version = cursor.fetchone()[0]
          print(f'âœ… PostgreSQL: {version[:50]}')
          assert 'PostgreSQL' in version
          "

      - name: Run tests in Docker
        run: |
          docker compose exec -T web pytest -v \
            --cov=booking \
            --cov=gym \
            --cov-report=term-missing

      - name: Collect static files in Docker
        run: |
          docker compose exec -T web \
            python manage.py collectstatic --noinput

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Web Container Logs ==="
          docker compose logs web
          echo "=== DB Container Logs ==="
          docker compose logs db

      - name: Stop and clean up Docker containers
        if: always()
        run: docker compose down -v

  api:
    name: API Smoke Tests
    runs-on: ubuntu-latest
    needs: test

    env:
      SECRET_KEY: test-secret-key-for-api-checks
      DEBUG: True                                    # â† Make sure this is True
      ALLOWED_HOSTS: localhost,127.0.0.1,testserver  # â† Add testserver
      DJANGO_SETTINGS_MODULE: fitzone.settings

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create media directories
        run: |
          mkdir -p media/{sliders,programs,trainers,gallery,testimonials,profiles}

      - name: Run migrations
        run: python manage.py migrate --noinput

      - name: Verify API endpoints exist
        run: |
          python manage.py shell -c "
          from django.urls import reverse
          
          print('ðŸ” Checking API endpoints...')
          
          endpoints = [
              'program-list',
              'trainer-list',
              'slider-list',
              'faq-list',
              'gallery-list',
              'testimonial-list',
          ]
          
          for name in endpoints:
              url = reverse(name)
              print(f'  âœ… {name:20} â†’ {url}')
          
          auth_endpoints = [
              'request-otp',
              'verify-otp',
              'token-refresh',
              'current-user',
          ]
          
          for name in auth_endpoints:
              url = reverse(name)
              print(f'  âœ… {name:20} â†’ {url}')
          
          for name in ['swagger-ui', 'redoc', 'schema']:
              url = reverse(name)
              print(f'  âœ… {name:20} â†’ {url}')
          
          print('âœ… All API endpoints verified')
          "

      - name: Test complete OTP â†’ JWT flow
        run: |
          python manage.py shell -c "
          import json
          from rest_framework.test import APIClient
          from booking.models import GymUser, OTP
          
          client = APIClient()
          phone = '9876543210'
          
          print('ðŸ” Testing OTP â†’ JWT authentication flow...')
          
          # Clear old OTPs
          OTP.objects.filter(phone=phone).delete()
          
          # Step 1: Request OTP
          print('  1ï¸âƒ£  Requesting OTP...')
          response = client.post(
              '/api/booking/auth/request-otp/',
              {'phone': phone},
              format='json'
          )
          
          # Debug on failure
          if response.status_code != 200:
              print(f'âŒ Status: {response.status_code}')
              print(f'âŒ Response: {response.content.decode()}')
              import sys
              sys.exit(1)
          
          data = response.data
          otp_code = data['otp']
          print(f'     âœ… OTP received: {otp_code}')
          
          # Step 2: Verify OTP
          print('  2ï¸âƒ£  Verifying OTP...')
          response = client.post(
              '/api/booking/auth/verify-otp/',
              {'phone': phone, 'otp': otp_code},
              format='json'
          )
          
          if response.status_code != 200:
              print(f'âŒ Verify failed: {response.status_code}')
              print(f'âŒ Response: {response.content.decode()}')
              import sys
              sys.exit(1)
          
          data = response.data
          assert 'tokens' in data
          assert 'access' in data['tokens']
          access_token = data['tokens']['access']
          print('     âœ… JWT tokens issued')
          
          # Step 3: Use token
          print('  3ï¸âƒ£  Testing protected endpoint with token...')
          client.credentials(HTTP_AUTHORIZATION=f'Bearer {access_token}')
          response = client.get('/api/booking/auth/me/')
          
          if response.status_code != 200:
              print(f'âŒ Auth failed: {response.status_code}')
              import sys
              sys.exit(1)
          
          assert response.data['phone'] == phone
          print('     âœ… Protected endpoint accessible with token')
          
          # Step 4: No token â†’ 401
          print('  4ï¸âƒ£  Testing protected endpoint without token...')
          client.credentials()  # Clear token
          response = client.get('/api/booking/auth/me/')
          assert response.status_code == 401
          print('     âœ… Unauthenticated request correctly rejected')
          
          print('âœ… Full OTP â†’ JWT flow passed')
          "

      - name: Verify Swagger documentation loads
        run: |
          python manage.py shell -c "
          from django.test import Client
          
          client = Client()
          print('ðŸ“š Checking API documentation...')
          
          docs = [
              ('/api/schema/',  'OpenAPI Schema'),
              ('/api/docs/',    'Swagger UI'),
              ('/api/redoc/',   'ReDoc'),
          ]
          
          for url, name in docs:
              response = client.get(url)
              assert response.status_code == 200, f'{name} at {url} returned {response.status_code}'
              print(f'  âœ… {name:20} â†’ {url}')
          
          print('âœ… All documentation endpoints working')
          "

      - name: Verify superuser creation
        run: |
          python manage.py shell -c "
          from booking.models import GymUser
          
          print('ðŸ‘¤ Testing superuser creation...')
          
          admin = GymUser.objects.create_superuser(
              phone='1010101010',
              email='admin@citest.com',
              password='adminpass123'
          )
          
          assert admin.is_staff is True, 'Superuser must be staff'
          assert admin.is_superuser is True, 'Superuser must have superuser flag'
          assert admin.has_usable_password(), 'Superuser must have usable password'
          assert admin.check_password('adminpass123'), 'Superuser password must work'
          
          print('âœ… Superuser creation and authentication verified')
          
          admin.delete()
          "

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [test, lint, security, docker, api]
    if: always()

    steps:
      - name: Display build results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ‹ï¸  FitZone CI/CD Build Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Tests:           ${{ needs.test.result }}"
          echo "Code Quality:    ${{ needs.lint.result }}"
          echo "Security:        ${{ needs.security.result }}"
          echo "Docker:          ${{ needs.docker.result }}"
          echo "API Smoke Tests: ${{ needs.api.result }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check mandatory jobs
        run: |
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "âŒ Tests failed â€” pipeline BLOCKED"
            exit 1
          fi
          echo "âœ… Tests passed (115+ tests)"

          if [ "${{ needs.api.result }}" != "success" ]; then
            echo "âŒ API smoke tests failed â€” pipeline BLOCKED"
            exit 1
          fi
          echo "âœ… API smoke tests passed"

          if [ "${{ needs.docker.result }}" != "success" ]; then
            echo "âš ï¸  Docker build failed â€” please check docker compose configuration"
            exit 1
          fi
          echo "âœ… Docker build passed"

          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "âœ… Code quality passed"
          else
            echo "âš ï¸  Code quality issues (non-blocking)"
          fi

          if [ "${{ needs.security.result }}" = "success" ]; then
            echo "âœ… Security scan passed"
          else
            echo "âš ï¸  Security warnings detected (non-blocking)"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ Build completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"